# 하이브리드 데이터 임베딩 시스템

## 🚀 개요

MariaDB 테이블 데이터를 Neo4j에 하이브리드 방식으로 임베딩하는 시스템입니다.

### 📊 하이브리드 임베딩의 구성요소

1. **스키마 메타데이터**: 테이블/컬럼 구조와 관계 정보
2. **실제 데이터 그래프화**: 테이블 레코드를 노드와 관계로 변환
3. **벡터 임베딩**: 텍스트 데이터의 시맨틱 검색 지원

## 📁 파일 구조

- `data_embedder.py`: 데이터 임베딩 전용 모듈
- `query_gen.py`: 메인 쿼리 생성기 (임베딩 기능 통합)

## 🛠️ 사용법

### 1. 기본 실행
```bash
python query_gen.py
```

프로그램 시작 시 자동으로 데이터 임베딩이 실행됩니다.

### 2. 대화형 명령어

- `stats`: 임베딩 통계 확인
- 일반 텍스트: SQL 쿼리 생성

### 3. 독립 실행
```bash
python data_embedder.py
```

임베딩만 독립적으로 실행할 수 있습니다.

## 🔧 주요 기능

### DataEmbedder 클래스

#### 메서드들
- `embed_schema_metadata()`: MariaDB에서 스키마 동적 추출 및 임베딩
- `embed_actual_data()`: 모든 테이블 데이터를 노드로 변환
- `embed_text_vectors()`: 텍스트 컬럼 자동 감지 및 벡터화
- `full_hybrid_embedding()`: 전체 프로세스 자동 실행
- `get_embedding_stats()`: 통계 정보 조회

#### 생성되는 Neo4j 구조

**메타데이터 레이어:**
- `(:Table)`: 동적으로 감지된 테이블 정보
- `(:Column)`: 동적으로 감지된 컬럼 정보
- `[:HAS_COLUMN]`: 테이블-컬럼 관계
- `[:REFERENCES]`: 외래키 관계 (자동 감지)

**데이터 레이어:**
- 각 테이블별 노드 (테이블명을 레이블로 사용)
- 모든 컬럼 데이터가 노드 속성으로 저장

**벡터 임베딩:**
- 텍스트 컬럼(50자 이상) 자동 감지
- 각 노드에 `embedding` 속성 추가
- 벡터 검색 인덱스 자동 생성

## 💡 활용 예시

### 1. 기본 쿼리
```
"사용자 테이블의 모든 컬럼을 보여줘"
```

### 2. 복합 관계 쿼리
```
"가장 많이 주문한 사용자의 선호 카테고리는?"
```

### 3. 시맨틱 검색 (향후 확장)
```
"아이폰과 비슷한 상품 찾기"
```

## 🔍 Neo4j 벡터 인덱스

자동으로 생성되는 벡터 인덱스:
- `product_embeddings`: 상품 임베딩용
- `review_embeddings`: 리뷰 임베딩용  
- `category_embeddings`: 카테고리 임베딩용

## ⚙️ 설정

### 필수 패키지
```txt
langchain-neo4j==0.5.0
langchain-huggingface
sentence-transformers>=2.2.2
torch>=2.0.0
pymysql>=1.0.2
```

### 연결 설정
- **Neo4j**: `bolt://localhost:7687`
- **MariaDB**: `localhost:32000`

### 임베딩 모델
- 모델: `BAAI/bge-m3` (HuggingFace)
- 벡터 차원: 1024
- 유사도 함수: cosine
- 자동 다운로드: 첫 실행 시 자동으로 모델 다운로드

## 📈 성능 특징

### 장점
1. **다층 검색**: 스키마 + 데이터 + 시맨틱
2. **관계 분석**: 그래프 알고리즘 활용 가능
3. **확장성**: 벡터 검색으로 추천 시스템 구축
4. **유연성**: 필요에 따라 부분 임베딩 가능

### 주의사항
1. **메모리 사용량**: 벡터 데이터로 인한 메모리 증가
2. **초기화 시간**: 첫 임베딩 시 시간 소요
3. **데이터 동기화**: RDB 변경 시 재임베딩 필요

## 🚨 에러 처리

임베딩 과정에서 개별 레코드 실패 시에도 전체 프로세스는 계속 진행됩니다. 실패한 항목은 로그로 기록되며, 통계에서 확인 가능합니다.

## 🔄 업데이트 및 유지보수

- 데이터 변경 시: `stats` 명령어로 상태 확인
- 스키마 변경 시: 코드 수정 후 전체 재임베딩
- 성능 모니터링: `stats` 명령어로 상태 확인

## 🔍 BGE-M3 모델 자동 다운로드

BGE-M3 모델은 첫 실행 시 HuggingFace에서 자동으로 다운로드됩니다:
- 모델 크기: 약 2.3GB
- 다운로드 위치: `~/.cache/huggingface/transformers/`
- 인터넷 연결 필요 (첫 실행시만)

### 패키지 설치
```bash
pip install -r requirements.txt
```

이제 시스템이 **완전히 자동화**되어 어떤 MariaDB 데이터베이스든 연결만 하면 자동으로 Neo4j에 하이브리드 임베딩됩니다!